<template>
  <view class="container">
    <view class="topbar">
      <view class="topbar-container">
        <view class="topbar-item" bindtap="order"><text class="iconfont icon-pailie"></text>排序</view>
        <view class="topbar-item" bindtap="toMap"><text class="iconfont icon-ditu"></text>地图</view>
      </view>
    </view>
    <view class="contentlist">
      <list :resList.sync="resList"></list>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import _ from 'lodash'
  import List from '../components/reslist'
  import host from '../config.js'
  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '杭州商品住房摇号查询'
    }
    components = {
      list: List
    }
    data = {
      resList: []
    }
    onLoad() {
      this.getHouseInfo('id')
    }
    onShareAppMessage(){
      return {
        title: '杭州商品住房摇号查询',
        path:'/pages/index'
      }
    }
    // 根据条件获取房源信息
    getHouseInfo(type) {
      var that = this
      var date = this.getNowFormatDate()
      return new Promise((resolve,reject) => {
        wx.request({
          url: host.service.getBuildingUrl,
          data: {
            type: type,
            date: date
          },
          method: 'POST',
          success: function(res){
            resolve(res.data.data)
          }
        })
      }).then(res => {
        var data = res
        var list_new = []
        data.forEach((val) => {
          list_new.push({
            id: val.id,
            suolue: val.suolue,
            locate: val.locate,
            name: val.building,
            price: val.average_price,
            lnglat: val.coordinate
          })
        })
        
        that.resList = list_new
        wx.showShareMenu()
        that.$apply()
      })
    }

    // 获取当前时间
    getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var seperator2 = ":";
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
                + " " + date.getHours() + seperator2 + date.getMinutes()
                + seperator2 + date.getSeconds();
        return currentdate;
    }

    // 条件筛选
  order(){
    var that = this
    wx.showActionSheet({
        itemList: ['更新时间排序', '均价排序', '房源数量排序'],
        success: function(res) {
          if(res.tapIndex == 1) {
            wx.showToast({
              title: '按均价排序'
            })
            that.getHouseInfo('price')
            setTimeout(() => {
              wx.hideToast()
            }, 1500);
          } else if(res.tapIndex == 0){
            wx.showToast({
              title: '按更新时间排序'
            })
            that.getHouseInfo('id')
            setTimeout(() => {
              wx.hideToast()
            }, 1500);
          } else if(res.tapIndex == 2){
            wx.showToast({
              title: '按房源数量排序'
            })
            that.getHouseInfo('housenum')
            setTimeout(() => {
              wx.hideToast()
            }, 1500);
          }
        },
        fail: function(res) {
          console.log(res.errMsg)
        }
      })
  }

    // 跳转到地图
    toMap(){
      wx.navigateTo({
        url: '/pages/map'
      })
    }
  }  
</script>
<style>
/* 顶部栏 */
.topbar{
  position: fixed;
  width:100%;
  left: 0;
  top: 0;
  overflow: hidden;
  background: #fff;
  z-index: 2;
  border-bottom:1px solid #f4f4f4;
}
.topbar-container{
  height: 18px;
  padding: 15px 20px;
}
.topbar-item{
  font-size:16px;
  float: left;
  margin-right:20px;
}
.topbar-item .iconfont{
  margin-right: 2px;
}

/* 内容列表 */
.contentlist{
  width: 100%;
  position: absolute;
  left: 0;
  top: 50px;
}
</style>
